
---
- name: Ensure Magento home directory exists
  file:
    path: "{{ magento2_home }}"
    state: directory
    owner: "{{ magento2_user }}"
    group: "{{ magento2_group }}"
    mode: '0755'

- name: Check if Composer is installed
  command: which composer
  register: composer_check
  ignore_errors: true
  changed_when: false

- name: Install Composer globally if missing
  shell: |
    php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
    php composer-setup.php --install-dir=/usr/local/bin --filename=composer
    rm composer-setup.php
  when: composer_check.rc != 0

- name: Ensure Composer auth directory exists
  file:
    path: "/home/{{ magento2_user }}/.composer"
    state: directory
    owner: "{{ magento2_user }}"
    group: "{{ magento2_group }}"
    mode: '0700'

- name: Deploy Composer auth.json
  template:
    src: auth.json.j2
    dest: "/home/{{ magento2_user }}/.composer/auth.json"
    owner: "{{ magento2_user }}"
    group: "{{ magento2_group }}"
    mode: '0600'

- name: Ensure acl package is installed
  apt:
    name: acl
    state: present
    update_cache: yes

- name: Check if Magento is already installed
  stat:
    path: "{{ magento2_home }}/.magento_installed"
  register: magento_installed

- name: Check if Magento home directory has files
  find:
    paths: "{{ magento2_home }}"
    file_type: any
  register: magento2_dir

- name: Run composer install if composer.json exists
  command: composer install --no-dev
  args:
    chdir: "{{ magento2_home }}"
  become_user: "{{ magento2_user }}"
  environment:
    COMPOSER_HOME: "/home/{{ magento2_user }}/.composer"
  when:
    - not magento_installed.stat.exists
    - magento2_dir.matched > 0

- name: Install Magento via Composer (create-project)
  command: >
    composer create-project --repository-url=https://repo.magento.com/
    magento/project-community-edition .
  args:
    chdir: "{{ magento2_home }}"
  become_user: "{{ magento2_user }}"
  environment:
    COMPOSER_HOME: "/home/{{ magento2_user }}/.composer"
  when:
    - not magento_installed.stat.exists
    - magento2_dir.matched == 0

- name: Set proper permissions for Magento directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ magento2_user }}"
    group: "{{ magento2_group }}"
    recurse: yes
  with_items:
    - "{{ magento2_home }}/var"
    - "{{ magento2_home }}/generated"
    - "{{ magento2_home }}/pub/static"
    - "{{ magento2_home }}/vendor"

- name: Run Magento setup:install
  command: >
    bin/magento setup:install
    --base-url=https://{{ magento2_domain }}
    --db-host=localhost
    --db-name={{ mysql_magento2_db }}
    --db-user={{ mysql_magento2_user }}
    --db-password={{ mysql_magento2_password }}
    --admin-firstname={{ magento2_admin_firstname }}
    --admin-lastname={{ magento2_admin_lastname }}
    --admin-email={{ magento2_admin_email }}
    --admin-user={{ magento2_admin_user }}
    --admin-password={{ magento2_admin_password }}
    --language=en_US
    --currency=USD
    --timezone=UTC
    --elasticsearch-host={{ elasticsearch_host }}
    --elasticsearch-port={{ elasticsearch_port }}
    --backend-frontname=admin
    --use-rewrites=1
  args:
    chdir: "{{ magento2_home }}"
  become_user: "{{ magento2_user }}"
  when: not magento_installed.stat.exists

- name: Deploy Magento sample data
  command: bin/magento sampledata:deploy
  args:
    chdir: "{{ magento2_home }}"
  become_user: "{{ magento2_user }}"
  when: not magento_installed.stat.exists

- name: Run Magento reindex
  command: bin/magento indexer:reindex
  args:
    chdir: "{{ magento2_home }}"
  become_user: "{{ magento2_user }}"
  when: not magento_installed.stat.exists

- name: Flush Magento cache
  command: bin/magento cache:flush
  args:
    chdir: "{{ magento2_home }}"
  become_user: "{{ magento2_user }}"
  when: not magento_installed.stat.exists

- name: Create Magento installed flag file
  file:
    path: "{{ magento2_home }}/.magento_installed"
    state: touch
  when: not magento_installed.stat.exists