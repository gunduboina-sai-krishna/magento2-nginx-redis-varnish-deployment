---

# Step 0: Ensure magento2 home directory exists
- name: Ensure magento2 home directory exists
  ansible.builtin.file:
    path: "{{ magento2_home }}"
    state: directory
    owner: "{{ magento2_user }}"
    group: "{{ magento2_group }}"
    mode: '0755'

# Step 1: Check if Composer is installed
- name: Check if Composer is installed
  ansible.builtin.command: which composer
  register: composer_check
  ignore_errors: true
  changed_when: false

# Step 2: Install Composer if missing
- name: Install Composer globally
  ansible.builtin.shell: |
    php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
    php composer-setup.php --install-dir=/usr/local/bin --filename=composer
    rm composer-setup.php
  when: composer_check.rc != 0
  become: true

# Step 3: Ensure Composer auth directory exists
- name: Ensure Composer auth directory exists
  ansible.builtin.file:
    path: "/root/.composer"
    state: directory
    owner: root
    group: root
    mode: '0700'

# Step 4: Copy magento2 Marketplace auth.json template
- name: Deploy Composer auth.json
  ansible.builtin.template:
    src: "auth.json.j2"
    dest: "/root/.composer/auth.json"
    owner: root
    group: root
    mode: '0600'

- name: Ensure acl package present
  ansible.builtin.apt:
    name: acl
    state: present
    update_cache: yes
  become: true

# Step 5: Check if magento2 is already installed
- name: Check if magento2 is already installed
  ansible.builtin.stat:
    path: "{{ magento2_home }}/bin/magento2"
  register: magento2_installed

# Step 6: Install magento2 via Composer
- name: Download Magento2 via Composer
  ansible.builtin.command: >
    composer create-project --repository-url=https://repo.magento.com/
    magento/project-community-edition .
  args:
    chdir: "{{ magento2_home }}"
  become: true
  become_user: "{{ magento2_user }}"
  become_flags: "-H -S"
  environment:
    COMPOSER_HOME: "/home/{{ magento2_user }}/.composer"
  when: not magento2_installed.stat.exists


# Step 7: Run magento2 setup:install
- name: Run magento2 setup:install
  ansible.builtin.command: >
    bin/magento2 setup:install
    --base-url=https://{{ magento2_domain }}
    --db-host=localhost
    --db-name={{ mysql_magento2_db }}
    --db-user={{ mysql_magento2_user }}
    --db-password={{ mysql_magento2_password }}
    --admin-firstname={{ magento2_admin_firstname }}
    --admin-lastname={{ magento2_admin_lastname }}
    --admin-email={{ magento2_admin_email }}
    --admin-user={{ magento2_admin_user }}
    --admin-password={{ magento2_admin_password }}
    --language=en_US
    --currency=USD
    --timezone=UTC
    --elasticsearch-host={{ elasticsearch_host }}
    --elasticsearch-port={{ elasticsearch_port }}
    --backend-frontname=admin
    --use-rewrites=1
  args:
    chdir: "{{ magento2_home }}"
  become_user: "{{ magento2_user }}"
  when: not magento2_installed.stat.exists

# Step 8: Deploy magento2 sample data
- name: Deploy magento2 sample data
  ansible.builtin.command: bin/magento sampledata:deploy
  args:
    chdir: "{{ magento2_home }}"
  become_user: "{{ magento2_user }}"
  when: not magento2_installed.stat.exists

# Step 9: Reindex & flush cache
- name: Run magento2 indexer:reindex
  ansible.builtin.command: bin/magento indexer:reindex
  args:
    chdir: "{{ magento2_home }}"
  become_user: "{{ magento2_user }}"

- name: Flush magento2 cache
  ansible.builtin.command: bin/magento cache:flush
  args:
    chdir: "{{ magento2_home }}"
  become_user: "{{ magento2_user }}"
