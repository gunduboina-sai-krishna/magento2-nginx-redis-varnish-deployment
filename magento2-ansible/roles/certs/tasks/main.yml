---
- name: Ensure SSL directory exists
  ansible.builtin.file:
    path: /etc/ssl/magento2
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Generate self-signed SSL certificate for magento2
  ansible.builtin.command: >
    openssl req -x509 -nodes -days 365
    -newkey rsa:2048
    -keyout /etc/ssl/magento2/magento2.key
    -out /etc/ssl/magento2/magento2.crt
    -subj "/C=IN/ST=Telangana/L=Hyderabad/O=magento2/OU=IT/CN=test.mgt.com"
  args:
    creates: /etc/ssl/magento2/magento2.crt   

- name: Ensure HTTP â†’ HTTPS redirection is configured
  ansible.builtin.lineinfile:
    path: /etc/nginx/sites-available/magento2.conf
    regexp: "return 301 https://"
    line: "return 301 https://$host$request_uri;"
    insertafter: "listen 80;"
  notify: reload nginx

- name: reload nginx
  ansible.builtin.service:
    name: nginx
    state: reloaded

# Update magento2 base URLs to HTTPS
- name: Update magento2 base URLs to use HTTPS
  ansible.builtin.command: >
    php {{ magento2_home }}/bin/magento setup:store-config:set
    --base-url="https://{{ magento2_domain }}/"
    --base-url-secure="https://{{ magento2_domain }}/"
  args:
    chdir: "{{ magento2_home }}"
  become_user: "{{ magento2_user }}"
  register: set_https_urls
  changed_when: "'Base URL' in set_https_urls.stdout"
